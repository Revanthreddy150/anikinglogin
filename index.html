<!DOCTYPE html>
<html>
<head>
  <title>Login App</title>
  <style>
    body {
      font-family: Arial;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #f0f2f5;
      margin: 0;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      width: 320px;
      text-align: center;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    input {
      width: 90%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 6px;
      background: #1877f2;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    #profile {
      display: none;
    }

    #profile img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      border: 3px solid #1877f2;
    }
  </style>
</head>
<body>

<div class="container" id="auth">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
  <p onclick="showSignup()" style="color:blue;cursor:pointer;">
    Create New Account
  </p>
</div>

<div class="container" id="signup" style="display:none;">
  <h2>Create Account</h2>
  <input type="email" id="signupEmail" placeholder="Email"><br>
  <input type="password" id="signupPassword" placeholder="Password"><br>
  <button onclick="signup()">Create</button>
</div>

<div class="container" id="profile">
  <h2>Profile</h2>
  <img id="profileImage" src="https://via.placeholder.com/120" onclick="uploadImage()">
  <input type="file" id="imageInput" style="display:none" accept="image/*">
  <input type="text" id="username">
  <button onclick="saveProfile()">Save</button>
  <button onclick="logout()">Logout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyArqJycgZtlLpM7KQ2T9h-e2eJUHtMg-TY",
  authDomain: "tff-earns.firebaseapp.com",
  projectId: "tff-earns",
  storageBucket: "tff-earns.firebasestorage.app",
  messagingSenderId: "762695597074",
  appId: "1:762695597074:web:bd7a8df2df2806d5b26ccb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

window.showSignup = function() {
  document.getElementById("auth").style.display="none";
  document.getElementById("signup").style.display="block";
}

window.signup = async function() {
  const email = signupEmail.value;
  const password = signupPassword.value;
  const userCredential = await createUserWithEmailAndPassword(auth,email,password);
  await setDoc(doc(db,"users",userCredential.user.uid),{
    username: email,
    photoURL: ""
  });
}

window.login = async function() {
  await signInWithEmailAndPassword(auth,email.value,password.value);
}

onAuthStateChanged(auth, async (user)=>{
  if(user){
    auth.style.display="none";
    signup.style.display="none";
    profile.style.display="block";

    const docSnap = await getDoc(doc(db,"users",user.uid));
    if(docSnap.exists()){
      username.value = docSnap.data().username;
      if(docSnap.data().photoURL){
        profileImage.src = docSnap.data().photoURL;
      }
    }
  }
});

window.uploadImage = function(){
  imageInput.click();
}

imageInput.addEventListener("change", async ()=>{
  const file = imageInput.files[0];
  const storageRef = ref(storage,"profiles/"+auth.currentUser.uid);
  await uploadBytes(storageRef,file);
  const url = await getDownloadURL(storageRef);
  profileImage.src = url;
  await setDoc(doc(db,"users",auth.currentUser.uid),{
    username: username.value,
    photoURL: url
  });
});

window.saveProfile = async function(){
  await setDoc(doc(db,"users",auth.currentUser.uid),{
    username: username.value,
    photoURL: profileImage.src
  });
  alert("Profile Updated");
}

window.logout = function(){
  signOut(auth);
  location.reload();
}
</script>

</body>
</html>
